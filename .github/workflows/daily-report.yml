name: æ ªå¼ã‚¹ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°æ—¥æ¬¡ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ

# âš ï¸ é‡è¦: ç«‹èŠ±è¨¼åˆ¸APIã¯é›»è©±èªè¨¼ãŒå¿…é ˆã§ã€æœ‰åŠ¹æœŸé™ã¯3åˆ†é–“ã®ã¿ã§ã™ã€‚
# ã“ã®ãŸã‚ã€å®Œå…¨è‡ªå‹•åŒ–ï¼ˆcronï¼‰ã¯ä¸å¯èƒ½ã§ã™ã€‚æ‰‹å‹•å®Ÿè¡Œï¼ˆworkflow_dispatchï¼‰ã®ã¿ã‚µãƒãƒ¼ãƒˆã—ã¾ã™ã€‚
#
# æ¨å¥¨é‹ç”¨æ–¹æ³•:
#   1. ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§é›»è©±èªè¨¼ã‚’å®Ÿæ–½
#   2. 3åˆ†ä»¥å†…ã« scripts/run_daily_report.sh ã‚’å®Ÿè¡Œ
#   3. ç”Ÿæˆã•ã‚ŒãŸãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥
#   4. ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒGitHub Pagesã«è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆ118-127è¡Œç›®ï¼‰
#
# ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’æ‰‹å‹•å®Ÿè¡Œã™ã‚‹å ´åˆ:
#   1. ç«‹èŠ±è¨¼åˆ¸eæ”¯åº—ã§é›»è©±èªè¨¼ã‚’å®Ÿæ–½
#   2. 3åˆ†ä»¥å†…ã«ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’æ‰‹å‹•å®Ÿè¡Œï¼ˆRun workflowï¼‰
#   3. é›»è©±èªè¨¼ç¢ºèªãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã‚‹
#   æ³¨æ„: ã‚¿ã‚¤ãƒ ãƒ©ã‚°ãŒã‚ã‚‹ãŸã‚å¤±æ•—ã—ã‚„ã™ã„ã§ã™ã€‚ãƒ­ãƒ¼ã‚«ãƒ«å®Ÿè¡Œã‚’æ¨å¥¨ã—ã¾ã™ã€‚

on:
  # æ‰‹å‹•å®Ÿè¡Œã®ã¿ï¼ˆé›»è©±èªè¨¼ã®åˆ¶ç´„ã«ã‚ˆã‚Šè‡ªå‹•å®Ÿè¡Œã¯ä¸å¯ï¼‰
  workflow_dispatch:
    inputs:
      phone_auth_completed:
        description: 'ç«‹èŠ±è¨¼åˆ¸eæ”¯åº—ã§é›»è©±èªè¨¼ã‚’å®Œäº†ã—ã¾ã—ãŸã‹ï¼Ÿï¼ˆæœ‰åŠ¹æœŸé™: 3åˆ†é–“ï¼‰'
        required: true
        type: boolean
        default: false

jobs:
  generate-report:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # gh-pagesãƒ–ãƒ©ãƒ³ãƒã¸ã®æ›¸ãè¾¼ã¿æ¨©é™
      pages: write     # GitHub Pagesã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤æ¨©é™
      id-token: write  # OIDCèªè¨¼ç”¨ï¼ˆGitHub Pagesã§æ¨å¥¨ï¼‰

    steps:
      - name: é›»è©±èªè¨¼ã®ç¢ºèª
        if: ${{ !inputs.phone_auth_completed }}
        run: |
          echo "âŒ ã‚¨ãƒ©ãƒ¼: é›»è©±èªè¨¼ãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“"
          echo ""
          echo "ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œã™ã‚‹å‰ã«ã€ä»¥ä¸‹ã®æ‰‹é †ã‚’å®Œäº†ã—ã¦ãã ã•ã„:"
          echo "  1. ç«‹èŠ±è¨¼åˆ¸eæ”¯åº—ã«ãƒ­ã‚°ã‚¤ãƒ³"
          echo "  2. é›»è©±èªè¨¼ã‚’å®Ÿæ–½ï¼ˆæœ‰åŠ¹æœŸé™: 3åˆ†é–“ï¼‰"
          echo "  3. èªè¨¼å®Œäº†å¾Œã€ã™ãã«æœ¬ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œ"
          echo ""
          echo "é›»è©±èªè¨¼ã‚’å®Œäº†ã—ãŸã‚‰ã€'phone_auth_completed' ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦å†å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚"
          exit 1

      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Pythonç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: ã‚¹ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°å®Ÿè¡Œ
        env:
          TACHIBANA_USER_ID: ${{ secrets.TACHIBANA_USER_ID }}
          TACHIBANA_PASSWORD: ${{ secrets.TACHIBANA_PASSWORD }}
          TACHIBANA_ENVIRONMENT: ${{ secrets.TACHIBANA_ENVIRONMENT }}
          REPORT_OUTPUT_DIR: docs
          LOG_LEVEL: INFO
          ENABLE_AI_ANALYSIS: ${{ secrets.ENABLE_AI_ANALYSIS || 'false' }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          echo "ğŸ“Š ã‚¹ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ã‚’é–‹å§‹ã—ã¾ã™"
          python3 -m src.main

      - name: ç”Ÿæˆã•ã‚ŒãŸãƒ¬ãƒãƒ¼ãƒˆã®ç¢ºèª
        run: |
          echo "ğŸ“Š ç”Ÿæˆã•ã‚ŒãŸãƒ¬ãƒãƒ¼ãƒˆã‚’ç¢ºèªã—ã¾ã™"
          ls -lh docs/
          echo ""
          echo "ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆæ—¥æ™‚:"
          date

      - name: ç¾åœ¨æ™‚åˆ»ã‚’å–å¾—ï¼ˆã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”¨ï¼‰
        id: get-timestamp
        run: |
          # JSTæ™‚åˆ»ã‚’å–å¾—
          echo "timestamp=$(TZ=Asia/Tokyo date +'%Y-%m-%d %H:%M:%S JST')" >> $GITHUB_OUTPUT

      - name: GitHub Pagesãƒ‡ãƒ—ãƒ­ã‚¤
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs
          publish_branch: gh-pages
          keep_files: true  # éå»ã®ãƒ¬ãƒãƒ¼ãƒˆã‚’ä¿æŒï¼ˆç´¯ç©å‹ãƒ‡ãƒ—ãƒ­ã‚¤ï¼‰
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'ğŸ¤– æ—¥æ¬¡ãƒ¬ãƒãƒ¼ãƒˆæ›´æ–° - ${{ steps.get-timestamp.outputs.timestamp }} [Generated by GitHub Actions]'

      - name: ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†é€šçŸ¥
        run: |
          echo "âœ… GitHub Pagesã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸ"
          echo ""
          echo "ğŸ“Š ãƒ¬ãƒãƒ¼ãƒˆURL:"
          echo "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          echo ""
          echo "â€» GitHub Pagesã®åæ˜ ã«ã¯æ•°åˆ†ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™"
